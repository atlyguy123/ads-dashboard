<div class="conversion-rates-debug">
    <h3>Conversion Rates Assignment Debug</h3>
    <p>Analyze actual cohorts and conversion rates from the database</p>
    
    <!-- Overview Section -->
    <div class="overview-section">
        <h4>Overview Statistics</h4>
        <button class="btn btn-primary" data-action="load_overview">Load Overview</button>
        <div class="result-container" id="overview-results">
            <p>Click "Load Overview" to see database statistics...</p>
        </div>
    </div>

    <!-- Hierarchical Cohort Section -->
    <div class="cohort-section">
        <h4>Cohort Hierarchy Analysis</h4>
        <button class="btn btn-primary" data-action="load_cohort_tree">Load Cohort Tree</button>
        <button class="btn btn-secondary" data-action="expand_all_cohorts">Expand All</button>
        <button class="btn btn-secondary" data-action="collapse_all_cohorts">Collapse All</button>
        
        <div class="result-container" id="cohort-results">
            <p>Click "Load Cohort Tree" to see hierarchical cohort breakdown...</p>
        </div>
    </div>
</div>

<style>
.conversion-rates-debug {
    max-width: 1400px;
    margin: 0 auto;
}

.overview-section, .cohort-section {
    margin-bottom: 30px;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    background: #f9f9f9;
}

.result-container {
    margin-top: 15px;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background-color: white;
    min-height: 100px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin: 15px 0;
}

.stat-card {
    background: white;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #ddd;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stat-value {
    font-size: 24px;
    font-weight: bold;
    color: #007bff;
}

.stat-label {
    font-size: 14px;
    color: #666;
    margin-top: 5px;
}

/* Cohort Tree Styles */
.cohort-tree {
    margin-top: 15px;
}

.cohort-node {
    margin: 2px 0;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    background: white;
}

.cohort-header {
    padding: 10px 15px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    border-bottom: 1px solid #e0e0e0;
}

.cohort-header:hover {
    background: #e9ecef;
}

.cohort-header.expandable::before {
    content: "▶ ";
    font-size: 12px;
    color: #666;
}

.cohort-header.expanded::before {
    content: "▼ ";
}

.cohort-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.cohort-property {
    font-weight: bold;
    color: #333;
}

.cohort-stats {
    display: flex;
    gap: 15px;
    font-size: 14px;
}

.cohort-size {
    color: #666;
}

.cohort-size.meets-minimum {
    color: #28a745;
    font-weight: bold;
}

.cohort-size.below-minimum {
    color: #dc3545;
    font-weight: bold;
}

.cohort-rate {
    color: #007bff;
}

.cohort-accuracy {
    color: #6f42c1;
}

.cohort-children {
    display: none;
    padding-left: 30px;
    border-top: 1px solid #e0e0e0;
    background: #fdfdfd;
}

.cohort-children.expanded {
    display: block;
}

.accuracy-badge {
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: bold;
}

.accuracy-very_high { background-color: #d4edda; color: #155724; }
.accuracy-high { background-color: #cce7ff; color: #004085; }
.accuracy-medium { background-color: #fff3cd; color: #856404; }
.accuracy-low { background-color: #f8d7da; color: #721c24; }
.accuracy-default { background-color: #e2e3e5; color: #383d41; }

.btn {
    padding: 8px 16px;
    margin: 4px;
    border: 1px solid;
    border-radius: 4px;
    cursor: pointer;
    background: white;
}

.btn-primary {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
}

.btn-secondary {
    background-color: #6c757d;
    border-color: #6c757d;
    color: white;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Action button handlers
    document.addEventListener('click', function(e) {
        if (e.target.hasAttribute('data-action')) {
            const action = e.target.getAttribute('data-action');
            handleAction(action);
        }
        
        // Cohort tree expand/collapse
        if (e.target.classList.contains('cohort-header') && e.target.classList.contains('expandable')) {
            toggleCohortNode(e.target);
        }
    });
});

function handleAction(action) {
    const resultContainer = getResultContainer(action);
    
    if (resultContainer) {
        resultContainer.innerHTML = '<p>Loading...</p>';
    }
    
    // Make request to backend
    fetch(`/api/debug/modules/conversion_rates_debug/actions/${action}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            renderResult(action, data.data, resultContainer);
        } else {
            if (resultContainer) {
                resultContainer.innerHTML = `<p style="color: red;">Error: ${data.error || 'Unknown error occurred'}</p>`;
            }
        }
    })
    .catch(error => {
        if (resultContainer) {
            resultContainer.innerHTML = `<p style="color: red;">Request failed: ${error.message}</p>`;
        }
    });
}

function getResultContainer(action) {
    const containerMap = {
        'load_overview': 'overview-results',
        'load_cohort_tree': 'cohort-results',
        'expand_all_cohorts': null,
        'collapse_all_cohorts': null
    };
    
    const containerId = containerMap[action];
    return containerId ? document.getElementById(containerId) : null;
}

function renderResult(action, data, container) {
    if (!container) {
        if (action === 'expand_all_cohorts') {
            expandAllCohorts();
        } else if (action === 'collapse_all_cohorts') {
            collapseAllCohorts();
        }
        return;
    }
    
    switch (action) {
        case 'load_overview':
            renderOverview(data, container);
            break;
        case 'load_cohort_tree':
            renderCohortTree(data, container);
            break;
    }
}

function renderOverview(data, container) {
    const stats = data.overview_stats;
    
    let html = `
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">${formatNumber(stats.total_records)}</div>
                <div class="stat-label">Total Records</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${formatRate(stats.avg_trial_conversion)}</div>
                <div class="stat-label">Avg Trial Conversion</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${formatRate(stats.avg_trial_refund)}</div>
                <div class="stat-label">Avg Trial Refund</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${formatRate(stats.avg_purchase_refund)}</div>
                <div class="stat-label">Avg Purchase Refund</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${formatNumber(stats.default_accuracy_count)}</div>
                <div class="stat-label">Using Default Rates</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${formatNumber(stats.calculated_rates_count)}</div>
                <div class="stat-label">Calculated Rates</div>
            </div>
        </div>
        
        <h5>Accuracy Distribution</h5>
        <div class="stats-grid">
    `;
    
    data.accuracy_distribution.forEach(item => {
        html += `
            <div class="stat-card">
                <div class="stat-value">${formatNumber(item.count)}</div>
                <div class="stat-label">${createAccuracyBadge(item.accuracy_score)}</div>
            </div>
        `;
    });
    
    html += `</div>`;
    container.innerHTML = html;
}

function renderCohortTree(data, container) {
    let html = '<div class="cohort-tree">';
    html += renderCohortLevel(data.cohort_tree, 0);
    html += '</div>';
    container.innerHTML = html;
}

function renderCohortLevel(nodes, level) {
    let html = '';
    
    nodes.forEach(node => {
        const hasChildren = node.children && node.children.length > 0;
        const meetsMinimum = node.cohort_size >= 12;
        
        html += `
            <div class="cohort-node">
                <div class="cohort-header ${hasChildren ? 'expandable' : ''}" data-node-id="${node.id}">
                    <div class="cohort-info">
                        <span class="cohort-property">${node.property_name}: ${node.property_value || 'N/A'}</span>
                        <div class="cohort-stats">
                            <span class="cohort-size ${meetsMinimum ? 'meets-minimum' : 'below-minimum'}">
                                ${formatNumber(node.cohort_size)} users ${meetsMinimum ? '✅' : '❌'}
                            </span>
                            <span class="cohort-rate">Trial: ${formatRate(node.avg_trial_conversion)}</span>
                            <span class="cohort-rate">Refund: ${formatRate(node.avg_trial_refund)}</span>
                            <span class="cohort-accuracy">${createAccuracyBadge(node.most_common_accuracy)}</span>
                        </div>
                    </div>
                </div>
        `;
        
        if (hasChildren) {
            html += `<div class="cohort-children" data-parent-id="${node.id}">`;
            html += renderCohortLevel(node.children, level + 1);
            html += `</div>`;
        }
        
        html += `</div>`;
    });
    
    return html;
}

function toggleCohortNode(header) {
    const nodeId = header.getAttribute('data-node-id');
    const childrenContainer = document.querySelector(`[data-parent-id="${nodeId}"]`);
    
    if (childrenContainer) {
        if (childrenContainer.classList.contains('expanded')) {
            childrenContainer.classList.remove('expanded');
            header.classList.remove('expanded');
        } else {
            childrenContainer.classList.add('expanded');
            header.classList.add('expanded');
        }
    }
}

function expandAllCohorts() {
    document.querySelectorAll('.cohort-children').forEach(el => {
        el.classList.add('expanded');
    });
    document.querySelectorAll('.cohort-header.expandable').forEach(el => {
        el.classList.add('expanded');
    });
}

function collapseAllCohorts() {
    document.querySelectorAll('.cohort-children').forEach(el => {
        el.classList.remove('expanded');
    });
    document.querySelectorAll('.cohort-header.expandable').forEach(el => {
        el.classList.remove('expanded');
    });
}

// Helper functions
function formatRate(rate) {
    if (rate === null || rate === undefined || rate === 'N/A') return 'N/A';
    return (rate * 100).toFixed(1) + '%';
}

function formatNumber(num) {
    if (num === null || num === undefined) return 'N/A';
    return num.toLocaleString();
}

function createAccuracyBadge(accuracy) {
    if (!accuracy) return 'N/A';
    return `<span class="accuracy-badge accuracy-${accuracy}">${accuracy.replace('_', ' ').toUpperCase()}</span>`;
}
</script> 