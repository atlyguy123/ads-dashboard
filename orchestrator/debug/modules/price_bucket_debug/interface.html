<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Bucket Debug Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
            background: white;
        }

        .content {
            padding: 30px;
            min-height: 600px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .metric-card h3 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .metric-card p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .btn {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,123,255,0.3);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #6c757d;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .data-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        .table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .search-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 5px;
            display: block;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
            margin: 20px 0;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>üí∞ Price Bucket Debug Dashboard</h1>
            <p>Professional analytics for price bucket assignment pipeline</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('overview', this)">üìä Overview</button>
            <button class="tab" onclick="showTab('assignments', this)">üìã Assignments</button>
            <button class="tab" onclick="showTab('search', this)">üîç Search</button>
            <button class="tab" onclick="showTab('validation', this)">‚úÖ Validation</button>
            <button class="tab" onclick="showTab('conversions', this)">üí≥ Conversions</button>
            <button class="tab" onclick="showTab('samples', this)">üìë Samples</button>
        </div>

        <div class="content">
            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="section-title">Price Bucket Distribution Overview</div>
                <button class="btn" id="overview-btn" onclick="loadOverview()">üîÑ Load Overview Data</button>
                <div id="overview-content">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Click "Load Overview Data" to analyze price bucket distribution</p>
                    </div>
                </div>
            </div>

            <!-- Other tabs -->
            <div id="assignments" class="tab-content">
                <div class="section-title">Assignment Method Analysis</div>
                <button class="btn" id="assignments-btn" onclick="loadAssignments()">üìä Analyze Assignments</button>
                <div id="assignments-content">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Click "Analyze Assignments" to see how buckets were assigned</p>
                    </div>
                </div>
            </div>

            <div id="search" class="tab-content">
                <div class="section-title">Search User Assignments</div>
                <div class="search-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Product ID</label>
                            <input type="text" class="form-control" id="search-product" placeholder="e.g., glutenfree_map">
                        </div>
                        <div class="form-group">
                            <label>Country</label>
                            <input type="text" class="form-control" id="search-country" placeholder="e.g., US">
                        </div>
                        <div class="form-group">
                            <label>Min Bucket ($)</label>
                            <input type="number" class="form-control" id="search-min" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>Max Bucket ($)</label>
                            <input type="number" class="form-control" id="search-max" placeholder="100">
                        </div>
                    </div>
                    <button class="btn" id="search-btn" onclick="searchUsers()">üîç Search Users</button>
                </div>
                <div id="search-content"></div>
            </div>

            <div id="validation" class="tab-content">
                <div class="section-title">Data Integrity Validation</div>
                <button class="btn" id="validation-btn" onclick="validateData()">‚úÖ Run Validation</button>
                <div id="validation-content">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Click "Run Validation" to check data integrity</p>
                    </div>
                </div>
            </div>

            <div id="conversions" class="tab-content">
                <div class="section-title">Conversion Event Analysis</div>
                <button class="btn" id="conversions-btn" onclick="loadConversions()">üí≥ Analyze Conversions</button>
                <div id="conversions-content">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Click "Analyze Conversions" to view conversion events that create buckets</p>
                    </div>
                </div>
            </div>

            <div id="samples" class="tab-content">
                <div class="section-title">Sample Assignment Data</div>
                <button class="btn" id="samples-btn" onclick="loadSamples()">üìë Load Samples</button>
                <div id="samples-content">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Click "Load Samples" to see examples of each assignment type</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab management
        function showTab(tabName, clickedElement) {
            console.log(`Switching to tab: ${tabName}`, clickedElement);
            
            try {
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Remove active from all tabs
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Show selected tab
                const targetTab = document.getElementById(tabName);
                if (targetTab) {
                    targetTab.classList.add('active');
                    console.log(`Successfully showed tab: ${tabName}`);
                } else {
                    console.error(`Tab not found: ${tabName}`);
                }
                
                // Add active class to clicked tab
                if (clickedElement) {
                    clickedElement.classList.add('active');
                    console.log('Activated clicked element');
                }
            } catch (error) {
                console.error('Error in showTab:', error);
            }
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount || 0);
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('en-US').format(num || 0);
        }

        function formatPercent(num) {
            return `${(num || 0).toFixed(1)}%`;
        }

        // API helper
        async function apiCall(endpoint, data = {}) {
            console.log(`Making API call to: ${endpoint}`, data);
            try {
                const url = `/api/debug/modules/price_bucket_debug/actions/${endpoint}`;
                console.log(`Full URL: ${url}`);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                console.log(`Response status: ${response.status}`);
                const result = await response.json();
                console.log(`Response data:`, result);
                
                return result;
            } catch (error) {
                console.error(`API call error:`, error);
                return { success: false, error: error.message };
            }
        }

        // Loading states
        function setLoading(elementId, isLoading, buttonId = null) {
            const element = document.getElementById(elementId);
            const button = buttonId ? document.getElementById(buttonId) : null;
            
            if (isLoading) {
                element.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading data...</p>
                    </div>
                `;
                if (button) {
                    button.disabled = true;
                    button.innerHTML = '‚è≥ Loading...';
                }
            } else {
                if (button) {
                    button.disabled = false;
                    // Restore original button text based on the function
                    if (buttonId.includes('overview')) button.innerHTML = 'üîÑ Load Overview Data';
                    else if (buttonId.includes('assignment')) button.innerHTML = 'üìä Analyze Assignments';
                    else if (buttonId.includes('validation')) button.innerHTML = '‚úÖ Run Validation';
                    else if (buttonId.includes('conversion')) button.innerHTML = 'üí≥ Analyze Conversions';
                    else if (buttonId.includes('sample')) button.innerHTML = 'üìë Load Samples';
                }
            }
        }

        function showError(elementId, error) {
            document.getElementById(elementId).innerHTML = `
                <div class="error">
                    <h4>‚ùå Error</h4>
                    <p>${error}</p>
                </div>
            `;
        }

        // Overview functions
        async function loadOverview() {
            setLoading('overview-content', true, 'overview-btn');
            
            try {
                const result = await apiCall('get_bucket_overview');
                
                if (result.success) {
                    displayOverview(result.data);
                } else {
                    showError('overview-content', result.error);
                }
            } catch (error) {
                showError('overview-content', error.message);
            } finally {
                setLoading('overview-content', false, 'overview-btn');
            }
        }

        function displayOverview(data) {
            const { buckets, summary } = data;
            
            let html = `
                <div class="metrics-grid">
                    <div class="metric-card">
                        <h3>${formatNumber(summary.total_users)}</h3>
                        <p>Total Users</p>
                    </div>
                    <div class="metric-card">
                        <h3>${formatNumber(summary.positive_buckets)}</h3>
                        <p>Positive Buckets</p>
                    </div>
                    <div class="metric-card">
                        <h3>${formatNumber(summary.zero_buckets)}</h3>
                        <p>Zero Buckets</p>
                    </div>
                    <div class="metric-card">
                        <h3>${formatCurrency(summary.avg_positive_bucket)}</h3>
                        <p>Avg Positive Bucket</p>
                    </div>
                </div>
            `;

            if (buckets && buckets.length > 0) {
                html += `
                    <div class="data-table">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Product ID</th>
                                    <th>Country</th>
                                    <th>Price Bucket</th>
                                    <th>User Count</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                buckets.forEach(bucket => {
                    html += `
                        <tr>
                            <td>${bucket.product_id}</td>
                            <td>${bucket.country}</td>
                            <td>${formatCurrency(bucket.price_bucket)}</td>
                            <td>${formatNumber(bucket.user_count)}</td>
                            <td>${formatPercent(bucket.percentage)}</td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table></div>`;
            } else {
                html += `
                    <div class="empty-state">
                        <h3>No Price Buckets Found</h3>
                        <p>No users have been assigned price buckets yet. Run the pipeline first.</p>
                    </div>
                `;
            }
            
            document.getElementById('overview-content').innerHTML = html;
        }

        // Assignment functions
        async function loadAssignments() {
            setLoading('assignments-content', true, 'assignments-btn');
            
            try {
                const result = await apiCall('get_assignment_summary');
                
                if (result.success) {
                    displayAssignments(result.data);
                } else {
                    showError('assignments-content', result.error);
                }
            } catch (error) {
                showError('assignments-content', error.message);
            } finally {
                setLoading('assignments-content', false, 'assignments-btn');
            }
        }

        function displayAssignments(data) {
            const { assignment_summary, total_users } = data;
            
            let html = `
                <div class="metrics-grid">
                    <div class="metric-card">
                        <h3>${formatNumber(total_users)}</h3>
                        <p>Total Users</p>
                    </div>
                </div>
            `;

            if (assignment_summary && assignment_summary.length > 0) {
                html += `
                    <div class="data-table">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Assignment Type</th>
                                    <th>Users</th>
                                    <th>Percentage</th>
                                    <th>Avg Bucket</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                assignment_summary.forEach(item => {
                    const badgeClass = item.assignment_type.includes('Zero') ? 'badge-warning' : 
                                     item.assignment_type.includes('Own') ? 'badge-success' : 'badge-info';
                    
                    html += `
                        <tr>
                            <td><span class="badge ${badgeClass}">${item.assignment_type}</span></td>
                            <td>${formatNumber(item.user_count)}</td>
                            <td>${formatPercent(item.percentage)}</td>
                            <td>${formatCurrency(item.avg_bucket)}</td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table></div>`;
            } else {
                html += `<div class="empty-state"><p>No assignment data available</p></div>`;
            }
            
            document.getElementById('assignments-content').innerHTML = html;
        }

        // Search functions
        async function searchUsers() {
            const data = {
                product_id: document.getElementById('search-product').value,
                country: document.getElementById('search-country').value,
                min_bucket: document.getElementById('search-min').value,
                max_bucket: document.getElementById('search-max').value,
                limit: 100
            };
            
            setLoading('search-content', true, 'search-btn');
            
            try {
                const result = await apiCall('search_assignments', data);
                
                if (result.success) {
                    displaySearchResults(result.data);
                } else {
                    showError('search-content', result.error);
                }
            } catch (error) {
                showError('search-content', error.message);
            } finally {
                setLoading('search-content', false, 'search-btn');
            }
        }

        function displaySearchResults(data) {
            const { results, count } = data;
            
            let html = `
                <div class="alert alert-info">Found ${formatNumber(count)} results</div>
            `;

            if (results && results.length > 0) {
                html += `
                    <div class="data-table">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>User ID</th>
                                    <th>Product</th>
                                    <th>Country</th>
                                    <th>Bucket</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                results.forEach(result => {
                    const badgeClass = result.assignment_type.includes('Zero') ? 'badge-warning' : 
                                     result.assignment_type.includes('Own') ? 'badge-success' : 'badge-info';
                    
                    html += `
                        <tr>
                            <td><code>${result.distinct_id}</code></td>
                            <td>${result.product_id}</td>
                            <td>${result.country}</td>
                            <td>${formatCurrency(result.price_bucket)}</td>
                            <td><span class="badge ${badgeClass}">${result.assignment_type}</span></td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table></div>`;
            } else {
                html += `<div class="empty-state"><p>No results found</p></div>`;
            }
            
            document.getElementById('search-content').innerHTML = html;
        }

        // Validation functions
        async function validateData() {
            setLoading('validation-content', true, 'validation-btn');
            
            try {
                const result = await apiCall('validate_data');
                
                if (result.success) {
                    displayValidation(result.data);
                } else {
                    showError('validation-content', result.error);
                }
            } catch (error) {
                showError('validation-content', error.message);
            } finally {
                setLoading('validation-content', false, 'validation-btn');
            }
        }

        function displayValidation(data) {
            const { status, issues, statistics } = data;
            
            let html = `
                <div class="alert ${issues.length === 0 ? 'alert-success' : 'alert-warning'}">
                    <h4>${status}</h4>
                </div>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <h3>${formatNumber(statistics.total_valid_users)}</h3>
                        <p>Valid Users</p>
                    </div>
                    <div class="metric-card">
                        <h3>${formatNumber(statistics.assigned_users)}</h3>
                        <p>Assigned</p>
                    </div>
                    <div class="metric-card">
                        <h3>${formatPercent(statistics.assignment_rate)}</h3>
                        <p>Assignment Rate</p>
                    </div>
                </div>
            `;

            if (issues.length > 0) {
                html += `<div class="section-title">Issues Found</div>`;
                issues.forEach(issue => {
                    html += `<div class="alert alert-warning">${issue}</div>`;
                });
            }
            
            document.getElementById('validation-content').innerHTML = html;
        }

        // Conversion functions
        async function loadConversions() {
            setLoading('conversions-content', true, 'conversions-btn');
            
            try {
                const result = await apiCall('analyze_conversions');
                
                if (result.success) {
                    displayConversions(result.data);
                } else {
                    showError('conversions-content', result.error);
                }
            } catch (error) {
                showError('conversions-content', error.message);
            } finally {
                setLoading('conversions-content', false, 'conversions-btn');
            }
        }

        function displayConversions(data) {
            const { conversions, summary } = data;
            
            let html = `
                <div class="metrics-grid">
                    <div class="metric-card">
                        <h3>${formatNumber(summary.total_conversions)}</h3>
                        <p>Total Conversions</p>
                    </div>
                    <div class="metric-card">
                        <h3>${formatNumber(summary.unique_products)}</h3>
                        <p>Products</p>
                    </div>
                    <div class="metric-card">
                        <h3>${formatNumber(summary.unique_countries)}</h3>
                        <p>Countries</p>
                    </div>
                    <div class="metric-card">
                        <h3>${formatCurrency(summary.avg_revenue)}</h3>
                        <p>Avg Revenue</p>
                    </div>
                </div>
            `;

            if (conversions && conversions.length > 0) {
                html += `
                    <div class="data-table">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Country</th>
                                    <th>Event</th>
                                    <th>Count</th>
                                    <th>Avg Revenue</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                conversions.slice(0, 50).forEach(conv => {
                    html += `
                        <tr>
                            <td>${conv.product_id}</td>
                            <td>${conv.country}</td>
                            <td><span class="badge badge-info">${conv.event_name}</span></td>
                            <td>${formatNumber(conv.conversion_count)}</td>
                            <td>${formatCurrency(conv.avg_revenue)}</td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table></div>`;
            } else {
                html += `<div class="empty-state"><p>No conversion data found</p></div>`;
            }
            
            document.getElementById('conversions-content').innerHTML = html;
        }

        // Sample functions
        async function loadSamples() {
            setLoading('samples-content', true, 'samples-btn');
            
            try {
                const result = await apiCall('get_sample_data');
                
                if (result.success) {
                    displaySamples(result.data);
                } else {
                    showError('samples-content', result.error);
                }
            } catch (error) {
                showError('samples-content', error.message);
            } finally {
                setLoading('samples-content', false, 'samples-btn');
            }
        }

        function displaySamples(data) {
            const { samples } = data;
            let html = '';
            
            Object.keys(samples).forEach(type => {
                const sampleData = samples[type];
                html += `<div class="section-title">${type} (${sampleData.length} samples)</div>`;
                
                if (sampleData.length > 0) {
                    html += `
                        <div class="data-table">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>User ID</th>
                                        <th>Product</th>
                                        <th>Country</th>
                                        <th>Bucket</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    sampleData.slice(0, 10).forEach(sample => {
                        html += `
                            <tr>
                                <td><code>${sample.distinct_id}</code></td>
                                <td>${sample.product_id}</td>
                                <td>${sample.country}</td>
                                <td>${formatCurrency(sample.price_bucket)}</td>
                            </tr>
                        `;
                    });
                    
                    html += `</tbody></table></div>`;
                } else {
                    html += `<div class="empty-state"><p>No samples found</p></div>`;
                }
            });
            
            document.getElementById('samples-content').innerHTML = html;
        }
    </script>
</body>
</html> 